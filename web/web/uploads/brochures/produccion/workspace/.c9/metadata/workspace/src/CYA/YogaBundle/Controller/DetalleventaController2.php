{"filter":false,"title":"DetalleventaController2.php","tooltip":"/src/CYA/YogaBundle/Controller/DetalleventaController2.php","undoManager":{"mark":68,"position":68,"stack":[[{"start":{"row":80,"column":7},"end":{"row":80,"column":8},"action":"remove","lines":["/"],"id":2}],[{"start":{"row":80,"column":6},"end":{"row":80,"column":7},"action":"remove","lines":["*"],"id":3}],[{"start":{"row":79,"column":8},"end":{"row":79,"column":9},"action":"remove","lines":["*"],"id":4}],[{"start":{"row":79,"column":7},"end":{"row":79,"column":8},"action":"remove","lines":["/"],"id":5}],[{"start":{"row":48,"column":1},"end":{"row":48,"column":2},"action":"remove","lines":[" "],"id":7}],[{"start":{"row":48,"column":0},"end":{"row":48,"column":1},"action":"remove","lines":[" "],"id":8}],[{"start":{"row":47,"column":25},"end":{"row":48,"column":9},"action":"remove","lines":["","         "],"id":9}],[{"start":{"row":48,"column":2},"end":{"row":48,"column":3},"action":"remove","lines":[" "],"id":10}],[{"start":{"row":48,"column":1},"end":{"row":48,"column":2},"action":"remove","lines":[" "],"id":11}],[{"start":{"row":48,"column":0},"end":{"row":48,"column":1},"action":"remove","lines":[" "],"id":12}],[{"start":{"row":47,"column":25},"end":{"row":48,"column":9},"action":"remove","lines":["","         "],"id":13}],[{"start":{"row":42,"column":0},"end":{"row":42,"column":1},"action":"insert","lines":[" "],"id":14}],[{"start":{"row":42,"column":1},"end":{"row":42,"column":2},"action":"insert","lines":[" "],"id":15}],[{"start":{"row":42,"column":2},"end":{"row":42,"column":3},"action":"insert","lines":[" "],"id":16},{"start":{"row":42,"column":3},"end":{"row":42,"column":4},"action":"insert","lines":[" "]}],[{"start":{"row":42,"column":4},"end":{"row":42,"column":5},"action":"insert","lines":[" "],"id":17},{"start":{"row":42,"column":5},"end":{"row":42,"column":6},"action":"insert","lines":[" "]}],[{"start":{"row":42,"column":6},"end":{"row":42,"column":7},"action":"insert","lines":[" "],"id":18},{"start":{"row":42,"column":7},"end":{"row":42,"column":8},"action":"insert","lines":[" "]}],[{"start":{"row":42,"column":8},"end":{"row":42,"column":9},"action":"insert","lines":[" "],"id":19}],[{"start":{"row":42,"column":9},"end":{"row":42,"column":10},"action":"insert","lines":[" "],"id":20}],[{"start":{"row":42,"column":10},"end":{"row":42,"column":11},"action":"insert","lines":[" "],"id":21}],[{"start":{"row":42,"column":11},"end":{"row":42,"column":12},"action":"insert","lines":[" "],"id":22}],[{"start":{"row":42,"column":12},"end":{"row":42,"column":13},"action":"insert","lines":[" "],"id":23}],[{"start":{"row":46,"column":26},"end":{"row":46,"column":36},"action":"remove","lines":["movimiento"],"id":24},{"start":{"row":46,"column":26},"end":{"row":46,"column":27},"action":"insert","lines":["d"]}],[{"start":{"row":46,"column":27},"end":{"row":46,"column":28},"action":"insert","lines":["e"],"id":25}],[{"start":{"row":46,"column":28},"end":{"row":46,"column":29},"action":"insert","lines":["t"],"id":26}],[{"start":{"row":46,"column":29},"end":{"row":46,"column":30},"action":"insert","lines":["a"],"id":27}],[{"start":{"row":46,"column":30},"end":{"row":46,"column":31},"action":"insert","lines":["l"],"id":28}],[{"start":{"row":46,"column":31},"end":{"row":46,"column":32},"action":"insert","lines":["l"],"id":29}],[{"start":{"row":46,"column":32},"end":{"row":46,"column":33},"action":"insert","lines":["e"],"id":30}],[{"start":{"row":46,"column":33},"end":{"row":46,"column":34},"action":"insert","lines":["v"],"id":31}],[{"start":{"row":46,"column":34},"end":{"row":46,"column":35},"action":"insert","lines":["e"],"id":32}],[{"start":{"row":46,"column":35},"end":{"row":46,"column":36},"action":"insert","lines":["t"],"id":33}],[{"start":{"row":46,"column":36},"end":{"row":46,"column":37},"action":"insert","lines":["a"],"id":34}],[{"start":{"row":46,"column":36},"end":{"row":46,"column":37},"action":"remove","lines":["a"],"id":35}],[{"start":{"row":46,"column":35},"end":{"row":46,"column":36},"action":"remove","lines":["t"],"id":36}],[{"start":{"row":46,"column":35},"end":{"row":46,"column":36},"action":"insert","lines":["n"],"id":37}],[{"start":{"row":46,"column":36},"end":{"row":46,"column":37},"action":"insert","lines":["t"],"id":38}],[{"start":{"row":46,"column":37},"end":{"row":46,"column":38},"action":"insert","lines":["a"],"id":39}],[{"start":{"row":38,"column":0},"end":{"row":39,"column":6},"action":"remove","lines":["        ","      "],"id":40}],[{"start":{"row":37,"column":52},"end":{"row":38,"column":2},"action":"remove","lines":["","  "],"id":41}],[{"start":{"row":38,"column":8},"end":{"row":39,"column":0},"action":"insert","lines":["",""],"id":42},{"start":{"row":39,"column":0},"end":{"row":39,"column":8},"action":"insert","lines":["        "]}],[{"start":{"row":30,"column":6},"end":{"row":30,"column":30},"action":"remove","lines":["  /*combo de productos*/"],"id":43}],[{"start":{"row":30,"column":5},"end":{"row":30,"column":6},"action":"remove","lines":[" "],"id":44}],[{"start":{"row":30,"column":4},"end":{"row":30,"column":5},"action":"remove","lines":[" "],"id":45}],[{"start":{"row":30,"column":0},"end":{"row":30,"column":4},"action":"remove","lines":["    "],"id":46}],[{"start":{"row":29,"column":8},"end":{"row":30,"column":0},"action":"remove","lines":["",""],"id":47}],[{"start":{"row":26,"column":8},"end":{"row":204,"column":6},"action":"remove","lines":["$detalleventa = new Detalleventa();","        $form = $this->createForm(DetalleventaType::class, $detalleventa);","        $form->handleRequest($request);","        ","        $repository = $this->getDoctrine()->getRepository('CYAYogaBundle:Producto');","        $query = $repository->createQueryBuilder('u')","            ->where('u.isActive = :rol')","            ->setParameter('rol', '1')","            ->getQuery();","        $productos = $query->getResult();","        $productoQuery = $request->get('producto'); ","        ","        if ($form->isSubmitted() && $form->isValid()) ","        {","             /*","            $movimiento->setUsuario($this->get('security.token_storage')->getToken()->getUser());","            $movimiento->setTipo('MB'); */","            $em = $this->getDoctrine()->getManager();","            $em->persist($detalleventa);","            $em->flush();","            $successMessage = 'Producto agregado';","            $this->addFlash('mensaje', $successMessage);","            ","            return $this->redirectToRoute('cya_detalleventa_add');","        }","      ","       /* $saldo = 0;  ","","        $repository = $this->getDoctrine()->getRepository('CYAYogaBundle:Movimiento');","        $query = $repository->createQueryBuilder('m')","        ->orderBy('m.fecha', 'DESC')","        ->getQuery();","        $movimientos = $query->getResult();","","        foreach($movimientos as $mov){","            if($mov->getRubro()->getTipo() == 'D'){","                $saldo = $saldo - $mov->getMonto();","            }else{","                $saldo = $saldo + $mov->getMonto();","            }","        }","        ","        $paginator = $this->get('knp_paginator');","        $pagination = $paginator->paginate(","        $detalleventa, $request->query->getInt('page' , 1),","        10","        );","*/","        /*return $this->render('CYAYogaBundle:Detalleventa:add.html.twig', array('pagination' => $pagination, 'detalleventa' => $detalleventa,'form' => $form->createView()));*/","        return $this->render('CYAYogaBundle:Detalleventa:add.html.twig', array('form' => $form->createView(), 'productos' => $productos));","      ","    }","  /*  ","    public function indexAction(Request $request)","    {","        $searchQuery = $request->get('query');","        $tipoQuery = $request->get('tipo');","        $dcQuery = $request->get('dc');","        $fhQuery = $request->get('fh');","        $fdQuery = $request->get('fd');","        $rubroQuery = $request->get('rubro');","        $usuarioQuery = $request->get('usuario'); ","        ","        $select = \"SELECT m FROM CYAYogaBundle:Movimiento m WHERE m.monto > 0\";","","            ","        if(!empty($tipoQuery)){","            $select = $select . \" AND m.tipo = '\" . $tipoQuery .\"'\";","        }","        ","        if(!empty($dcQuery)){","            $select = $select . \" AND m.rubro in (SELECT r FROM CYAYogaBundle:Rubro r WHERE r.tipo = '\" . $dcQuery .\"')\";","        }","        ","        if(!empty($rubroQuery)){","            $select = $select . \" AND m.rubro = (SELECT r FROM CYAYogaBundle:Rubro r WHERE r.id = \" . $rubroQuery .\")\";","        }","        ","        if(!empty($fhQuery)){","            $select = $select . \" AND m.fecha <= '\" . $fhQuery .\" 23:59:59'\";","        }","        ","        if(!empty($fdQuery)){","            $select = $select . \" AND m.fecha >= '\" . $fdQuery .\" 00:00:00'\";","        }","        ","        if(!empty($usuarioQuery)){","            $select = $select . \" AND m.usuario = (SELECT u FROM CYAYogaBundle:Usuario u WHERE u.id = \" . $usuarioQuery .\")\";","        }","        ","        $select = $select . \" ORDER BY m.fecha DESC\";","        $em = $this->getDoctrine()->getManager();","        $query = $em->createQuery($select);","        $movimientos = $query->getResult();","","","        $paginator = $this->get('knp_paginator');","        $pagination = $paginator->paginate(","            $movimientos, $request->query->getInt('page' , 1),","            10","        );","        $em = $this->getDoctrine()->getManager();","        $rubros = $em->getRepository('CYAYogaBundle:Rubro')->findAll();","        ","        ","        $repository = $this->getDoctrine()->getRepository('CYAYogaBundle:Usuario');","        $query = $repository->createQueryBuilder('u')","            ->where('u.rol != :rol')","            ->setParameter('rol', 'ROLE_USER')","            ->getQuery();","        $usuarios = $query->getResult();","        ","        return $this->render('CYAYogaBundle:Movimiento:index.html.twig', array('pagination' => $pagination, 'rubros' => $rubros, 'usuarios' => $usuarios));","    }","    ","    public function deleteAction($id, Request $request)","    {","        ","        $em = $this->getDoctrine()->getManager();","        $movimiento = $em->getRepository('CYAYogaBundle:Movimiento')->find($id);","       ","        if(!$movimiento){","            throw $this->createNotFoundException('Movimiento no encontrado');","        }   ","        ","        if($movimiento->getTipo() == 'MB'){","            $em->remove($movimiento);","            $em->flush(); ","        }","        ","        if($movimiento->getTipo() == 'CC'){","            $alumnocc = new Alumnocc();","            $alumnocc = $movimiento->getAlumnocc();","            if($alumnocc->getTipo() == 'PC'){","                $montoborrado = $alumnocc->getPagado() - $movimiento->getMonto();","                $alumnocc->setPagado($montoborrado);","                $alumnocc->setFechamodificacion(new \\DateTime(\"now\"));","            }","","            $em->remove($movimiento);","            $em->flush(); ","            if($alumnocc->getTipo() == 'PD'){","                $em->remove($alumnocc);","                $em->flush(); ","            }","            ","        }","        ","        if($movimiento->getTipo() == 'VP'){","            $maestroventa = new Maestroventa();","            $maestroventa = $movimiento->getMaestroventa();","            ","            $detalleventas = $maestroventa->getDetalleventas();","            ","            foreach($detalleventas as $detalle){","            ","                $producto = new Producto();","                $producto = $detalle->getProducto();","                $producto->setStock($producto->getStock() + $detalle->getCantidad());","                $em->flush();","                ","                ","                $em->remove($detalle);","                $em->flush();","            }","            ","            $em->remove($maestroventa);","            $em->remove($movimiento);","            $em->flush();","            ","        }","","        ","        $successMessage = 'Movimiento eliminado';","        $this->addFlash('mensaje', $successMessage);","","        return $this->redirectToRoute('cya_movimiento_index');","    }","  */  "],"id":48}],[{"start":{"row":26,"column":7},"end":{"row":26,"column":8},"action":"insert","lines":["-"],"id":49}],[{"start":{"row":26,"column":7},"end":{"row":26,"column":8},"action":"remove","lines":["-"],"id":50}],[{"start":{"row":26,"column":7},"end":{"row":26,"column":8},"action":"insert","lines":["*"],"id":51}],[{"start":{"row":26,"column":7},"end":{"row":26,"column":8},"action":"remove","lines":["*"],"id":52}],[{"start":{"row":26,"column":6},"end":{"row":26,"column":7},"action":"remove","lines":[" "],"id":53}],[{"start":{"row":26,"column":6},"end":{"row":26,"column":7},"action":"insert","lines":["ñ"],"id":54}],[{"start":{"row":26,"column":6},"end":{"row":26,"column":7},"action":"remove","lines":["ñ"],"id":55}],[{"start":{"row":26,"column":6},"end":{"row":26,"column":7},"action":"insert","lines":["+"],"id":56}],[{"start":{"row":26,"column":6},"end":{"row":26,"column":7},"action":"remove","lines":["+"],"id":57}],[{"start":{"row":26,"column":6},"end":{"row":26,"column":7},"action":"insert","lines":["*"],"id":58}],[{"start":{"row":26,"column":6},"end":{"row":26,"column":7},"action":"remove","lines":["*"],"id":59}],[{"start":{"row":26,"column":6},"end":{"row":26,"column":7},"action":"insert","lines":["´"],"id":60},{"start":{"row":26,"column":7},"end":{"row":26,"column":8},"action":"insert","lines":["+"]}],[{"start":{"row":26,"column":7},"end":{"row":26,"column":8},"action":"remove","lines":["+"],"id":61}],[{"start":{"row":26,"column":6},"end":{"row":26,"column":7},"action":"remove","lines":["´"],"id":62}],[{"start":{"row":26,"column":5},"end":{"row":26,"column":6},"action":"insert","lines":["}"],"id":63},{"start":{"row":26,"column":0},"end":{"row":26,"column":5},"action":"remove","lines":["     "]},{"start":{"row":26,"column":0},"end":{"row":26,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":26,"column":4},"end":{"row":28,"column":4},"action":"insert","lines":["","        ","    "],"id":64}],[{"start":{"row":26,"column":4},"end":{"row":26,"column":32},"action":"insert","lines":[" print_r('Elija un Alumno');"],"id":65}],[{"start":{"row":26,"column":14},"end":{"row":26,"column":29},"action":"remove","lines":["Elija un Alumno"],"id":66},{"start":{"row":26,"column":14},"end":{"row":26,"column":15},"action":"insert","lines":["p"]}],[{"start":{"row":26,"column":15},"end":{"row":26,"column":16},"action":"insert","lines":["r"],"id":67}],[{"start":{"row":26,"column":16},"end":{"row":26,"column":17},"action":"insert","lines":["u"],"id":68}],[{"start":{"row":26,"column":17},"end":{"row":26,"column":18},"action":"insert","lines":["e"],"id":69}],[{"start":{"row":26,"column":18},"end":{"row":26,"column":19},"action":"insert","lines":["b"],"id":70}],[{"start":{"row":26,"column":19},"end":{"row":26,"column":20},"action":"insert","lines":["a"],"id":71}]]},"ace":{"folds":[],"scrolltop":63,"scrollleft":0,"selection":{"start":{"row":22,"column":17},"end":{"row":22,"column":17},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":3,"state":"php-start","mode":"ace/mode/php"}},"timestamp":1481406069999,"hash":"ab9933a16b78a51d0ed446fa961b99094ab3fa0f"}